# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# This Vagrantfile is for quick making a multi-host environment
# to experiment & play with Teleport.
#
#   1. Creates several identical VMs
#   2. Based on Debian Jessie 8
#   3. With private networking
#   4. With Docker installed
#
NODES = {
  "a-auth"  => "10.0.10.10", 
  "a-node"  => "10.0.10.12",
  "b-auth"  => "10.0.10.20", 
}

DOCKER_VER ||= "1.10.3"

Vagrant.configure(2) do |config|
  config.vm.box = "http://s3.gravitational.io/vms/libvirt-debian.box"
  config.vm.box_check_update = false

  basic_config(config.vm)
  configure_ssh(config.vm)
  apt_update(config.vm)
  install_docker(config.vm, DOCKER_VER)
  configure_teleport(config.vm)

  config.vm.synced_folder "../../", "/home/vagrant/teleport", type: "9p", disabled: false, accessmode: "mapped"

  NODES.each do |role, addr|
      config.vm.define role do |config|
          config.vm.hostname = role
          config.vm.network "private_network", ip: addr
          config.vm.provider "libvirt" do |vb|
              vb.driver = "kvm"
              vb.cpus = 1
              vb.memory = 512
          end
          config.vm.synced_folder "../data/opt/#{role}", "/opt/teleport", type: "9p", disabled: false, accessmode: "mapped"
          config.vm.synced_folder "../data/var/#{role}", "/var/lib/teleport", type: "rsync", disabled: false
      end
  end 
end
